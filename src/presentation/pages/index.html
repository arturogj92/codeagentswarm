<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://avatars.githubusercontent.com https://www.gravatar.com https://lh3.googleusercontent.com https://*.googleusercontent.com https://cdn.discordapp.com; connect-src 'self';">
    <title>CodeAgentSwarm - Claude Code Terminal Manager</title>
    <style>
        /* Critical CSS for instant loading */
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #1a1a1a;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .loading-content {
            text-align: center;
        }
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #333;
            border-top-color: #007ACC;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .loading-text {
            color: #888;
            font-size: 14px;
        }
    </style>
    <!-- Defer non-critical styles -->
    <link rel="preload" href="../../../styles/styles.css" as="style">
    <link rel="preload" href="../../../node_modules/xterm/css/xterm.css" as="style">
    <link rel="stylesheet" href="../../../styles/styles.css">
    <link rel="stylesheet" href="../../../node_modules/xterm/css/xterm.css">
    <!-- Directory selector MUST load after styles.css to override it -->
    <link rel="stylesheet" href="../../../styles/directory-selector-complete.css">
    <link rel="stylesheet" href="../../../styles/styles-badge.css">
    <link rel="stylesheet" href="../../../styles/diff-viewer.css">
    <link rel="stylesheet" href="../../../styles/feature-highlight.css">
    <link rel="stylesheet" href="../../../styles/mcp-settings.css">
    <link rel="stylesheet" href="../../../styles/mcp-marketplace.css">
    <link rel="stylesheet" href="../../../styles/global-permissions.css">
    <link rel="stylesheet" href="../../../styles/modal-scroll-fix.css">
    <link rel="stylesheet" href="../../../styles/auth.css">
    <link rel="stylesheet" href="../../../styles/task-modal-modern.css">
    <link rel="stylesheet" href="../../../styles/markdown-editor.css">
    <!-- Global Font Override - Must be loaded last -->
    <link rel="stylesheet" href="../../../styles/global-fonts.css">
    <!-- Load Lucide asynchronously -->
    <script defer src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Load TaskModal component -->
    <script src="../components/task-modal.js"></script>
</head>
<body>
    <!-- Loading screen -->
    <div class="loading-screen" id="loading-screen">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Starting CodeAgentSwarm...</div>
        </div>
    </div>
    <div class="app-container">
        <header class="header">
            <div class="header-left">
                <div class="logo-container">
                    <img src="../../../assets/icons/logo_prod.png" alt="CodeAgentSwarm" class="app-logo">
                </div>
                <div class="action-buttons">
                    <button class="btn-layout with-text" id="kanban-btn" data-tooltip="Task Manager ⌘K">
                        <i data-lucide="list-checks"></i>
                        <span>Tasks</span>
                    </button>
                    <button class="btn-layout with-text" id="create-task-btn" data-tooltip="Create Task ⌘T">
                        <i data-lucide="plus-square"></i>
                        <span>Create</span>
                    </button>
                </div>
                <button class="btn-layout git-button" id="git-status-btn" data-tooltip="Git Status ⌘G">
                    <i data-lucide="git-branch-plus"></i>
                </button>
            </div>
            <div class="header-controls">
                <div class="terminal-management">
                    <!-- Tabbed Layout Toggle Button -->
                    <button class="btn btn-layout btn-tabbed-mode" id="tabbed-mode-btn" title="Tabbed Fullscreen Mode">
                        <i data-lucide="square-stack"></i>
                    </button>
                    
                    <div class="layout-selector" id="layout-selector" style="display: none;">
                        <!-- 2 terminals layouts -->
                        <div class="layout-group" id="layout-2-terminals" style="display: none;">
                            <button class="btn btn-layout" id="layout-horizontal-btn" title="Horizontal Layout"><i data-lucide="columns-2"></i></button>
                            <button class="btn btn-layout" id="layout-vertical-btn" title="Vertical Layout"><i data-lucide="rows-2"></i></button>
                        </div>
                        
                        <!-- 3 terminals layouts -->
                        <div class="layout-group" id="layout-3-terminals" style="display: none;">
                            <button class="btn btn-layout" id="layout-3-top1-btn" title="1 Top + 2 Bottom Horizontal"><i data-lucide="layout-panel-top"></i></button>
                            <button class="btn btn-layout" id="layout-3-top2-horiz-btn" title="2 Top Horizontal + 1 Bottom">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide">
                                    <rect width="7" height="7" x="3" y="3" rx="1"></rect>
                                    <rect width="7" height="7" x="14" y="3" rx="1"></rect>
                                    <rect width="18" height="7" x="3" y="14" rx="1"></rect>
                                </svg>
                            </button>
                            <button class="btn btn-layout" id="layout-3-left2-btn" title="2 Left Vertical + 1 Right">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide">
                                    <rect width="7" height="7" x="3" y="3" rx="1"></rect>
                                    <rect width="7" height="7" x="3" y="14" rx="1"></rect>
                                    <rect width="7" height="18" x="14" y="3" rx="1"></rect>
                                </svg>
                            </button>
                            <button class="btn btn-layout" id="layout-3-right2-btn" title="1 Left + 2 Right Vertical">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide">
                                    <rect width="7" height="18" x="3" y="3" rx="1"></rect>
                                    <rect width="7" height="7" x="14" y="3" rx="1"></rect>
                                    <rect width="7" height="7" x="14" y="14" rx="1"></rect>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button class="btn btn-add-terminal" id="add-terminal-btn" data-tooltip="New Terminal ⌘N">
                        <i data-lucide="terminal"></i>
                        <i data-lucide="plus" class="add-icon"></i>
                    </button>
                </div>
                <button class="btn-layout" id="permissions-btn" title="Tool Permissions">
                    <i data-lucide="shield"></i>
                </button>
                <button class="btn-layout" id="auth-btn" title="Sign In">
                    <i data-lucide="user" id="auth-icon"></i>
                    <img id="user-avatar" alt="User Avatar" />
                </button>
                <button class="btn-layout" id="settings-btn" title="Settings">
                    <i data-lucide="settings"></i>
                </button>
            </div>
        </header>

        <!-- Tabbed Layout Container -->
        <div class="tabbed-layout-container" id="tabbed-layout-container" style="display: none;">
            <div class="terminal-tabs-bar">
                <div class="terminal-tabs" id="terminal-tabs">
                    <!-- Tabs will be dynamically generated here -->
                </div>
                <button class="btn-new-tab" id="new-tab-btn" title="New Terminal">
                    <i data-lucide="plus"></i>
                </button>
            </div>
            <div class="tabbed-terminal-content" id="tabbed-terminal-content">
                <!-- Active terminal will be shown here -->
            </div>
        </div>

        <main class="terminals-container" id="terminals-container">
            <!-- Terminals will be dynamically generated here -->
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-modal" id="close-settings">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <div class="tab-buttons">
                        <button class="tab-btn active" data-tab="general"><i data-lucide="settings-2"></i> General</button>
                        <button class="tab-btn" data-tab="shell"><i data-lucide="terminal"></i> Shell</button>
                        <button class="tab-btn" data-tab="permissions"><i data-lucide="shield"></i> Permissions</button>
                        <button class="tab-btn" data-tab="mcp-servers"><i data-lucide="server"></i> MCP Servers</button>
                        <button class="tab-btn" data-tab="updates"><i data-lucide="download"></i> Updates</button>
                        <button class="tab-btn" data-tab="mcp-tips"><i data-lucide="info"></i> MCP Tips</button>
                    </div>
                    
                    <div class="tab-content">
                        <!-- General Tab -->
                        <div class="tab-panel active" data-panel="general">
                            <div class="settings-section">
                                <h3><i data-lucide="bug"></i> Debug Mode</h3>
                                <label class="checkbox-option" for="debug-mode-checkbox">
                                    <span>Enable Debug Mode</span>
                                    <div class="toggle-wrapper">
                                        <input type="checkbox" id="debug-mode-checkbox">
                                        <div class="toggle-switch"></div>
                                    </div>
                                </label>
                                <p class="settings-note">Shows the logs button for debugging purposes</p>
                            </div>
                            
                            <div class="settings-section">
                                <h3><i data-lucide="bell"></i> Notifications</h3>
                                <p>Desktop notifications may not always work properly depending on your system settings:</p>
                                <ul class="settings-list">
                                    <li>Check your system notification settings</li>
                                    <li>Make sure CodeAgentSwarm has permission to show notifications</li>
                                    <li>Some systems may block Electron app notifications</li>
                                    <li>Task status changes are always visible in the Kanban board</li>
                                </ul>
                                <div class="notification-button-container">
                                    <button class="btn btn-primary notification-button" id="open-system-notifications">
                                        <i data-lucide="bell"></i>
                                        <span>Open System Notification Settings</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Shell Tab -->
                        <div class="tab-panel" data-panel="shell">
                            <div class="settings-section">
                                <h3>Terminal Shell</h3>
                                <div class="shell-options">
                                    <label class="radio-option">
                                        <input type="radio" name="shell-type" value="system" id="shell-system">
                                        <span>System Default (<span id="system-shell-path"></span>)</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="shell-type" value="bash" id="shell-bash">
                                        <span>Bash (/bin/bash)</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="shell-type" value="zsh" id="shell-zsh">
                                        <span>Zsh (/bin/zsh)</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="shell-type" value="fish" id="shell-fish">
                                        <span>Fish (/usr/local/bin/fish)</span>
                                    </label>
                                    <label class="radio-option">
                                        <input type="radio" name="shell-type" value="custom" id="shell-custom">
                                        <span>Custom</span>
                                    </label>
                                    <div class="custom-shell-input" id="custom-shell-container" style="display: none;">
                                        <input type="text" id="custom-shell-path" placeholder="/path/to/shell">
                                    </div>
                                </div>
                                <p class="settings-note">Note: Changes will apply to new terminal sessions only.</p>
                            </div>
                        </div>
                        
                        <!-- Permissions Tab -->
                        <div class="tab-panel" data-panel="permissions">
                            <div class="settings-section">
                                <div id="global-permissions-content">
                                    <!-- Global permissions manager will render here -->
                                    <div class="loading-permissions">
                                        <div class="loading-spinner"></div>
                                        <p>Loading permissions...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MCP Servers Tab -->
                        <div class="tab-panel" data-panel="mcp-servers">
                            <div class="settings-section">
                                <div class="mcp-header">
                                    <h3><i data-lucide="server"></i> MCP Servers</h3>
                                    <div class="mcp-header-buttons">
                                        <button class="btn btn-secondary btn-small" id="edit-permissions-btn">
                                            <i data-lucide="shield"></i>
                                            Edit Permissions
                                        </button>
                                        <button class="btn btn-secondary btn-small" id="open-marketplace-btn">
                                            <i data-lucide="shopping-bag"></i>
                                            Marketplace
                                        </button>
                                        <button class="btn btn-primary btn-small" id="add-mcp-btn">
                                            <i data-lucide="plus"></i>
                                            Add MCP Server
                                        </button>
                                    </div>
                                </div>
                                <p class="settings-note">Manage Model Context Protocol servers for Claude Code. These servers provide additional tools and capabilities.</p>
                                
                                <div class="mcp-servers-list" id="mcp-servers-list">
                                    <!-- MCP servers will be loaded here dynamically -->
                                    <div class="loading-mcp">
                                        <i data-lucide="loader-2" class="spin"></i>
                                        <span>Loading MCP servers...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Updates Tab -->
                        <div class="tab-panel" data-panel="updates">
                            <div class="settings-section">
                                <h3><i data-lucide="download-cloud"></i> Automatic Updates</h3>
                                <div class="update-info">
                                    <div class="current-version">
                                        <span>Current Version:</span>
                                        <strong id="current-version">Loading...</strong>
                                    </div>
                                    <div class="update-status" id="update-status">
                                        <i data-lucide="loader-2" class="spin"></i>
                                        <span>Checking for updates...</span>
                                    </div>
                                </div>
                                
                                <!-- Update Available Section -->
                                <div class="update-available-section" id="update-available-section" style="display: none;">
                                    <div class="update-details">
                                        <h4>New Version Available</h4>
                                        <div class="version-info">
                                            <span class="new-version">Version <strong id="new-version"></strong></span>
                                            <span class="release-date" id="release-date"></span>
                                        </div>
                                        <div class="release-notes-container">
                                            <div class="release-notes" id="release-notes"></div>
                                            <button class="btn btn-small btn-secondary" id="view-changelog-fullscreen" style="display: none;">
                                                <i data-lucide="maximize-2"></i>
                                                View Fullscreen
                                            </button>
                                        </div>
                                    </div>
                                    <div class="update-actions">
                                        <button class="btn btn-primary" id="download-update-btn">
                                            <i data-lucide="download"></i>
                                            Download Update
                                        </button>
                                        <button class="btn btn-secondary" id="skip-update-btn">
                                            Skip This Version
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Update Actions -->
                                <div class="update-actions" id="default-update-actions">
                                    <button class="btn btn-primary" id="check-updates-btn">
                                        <i data-lucide="refresh-cw"></i>
                                        Check for Updates
                                    </button>
                                </div>
                                
                                <!-- Download Progress -->
                                <div class="update-progress" id="update-progress" style="display: none;">
                                    <div class="progress-header">
                                        <h4>Downloading Update...</h4>
                                        <button class="btn btn-small btn-danger" id="cancel-download-btn">
                                            <i data-lucide="x"></i>
                                            Cancel
                                        </button>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="progress-fill"></div>
                                    </div>
                                    <div class="progress-info">
                                        <div class="progress-stats">
                                            <span id="progress-percent">0%</span>
                                            <span id="progress-size"></span>
                                        </div>
                                        <div class="progress-speed">
                                            <span id="progress-speed"></span>
                                            <span id="progress-eta"></span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Update Ready -->
                                <div class="update-ready" id="update-ready" style="display: none;">
                                    <div class="update-ready-info">
                                        <i data-lucide="check-circle" class="success-icon"></i>
                                        <h4>Update Downloaded</h4>
                                        <p>The update has been downloaded and is ready to install.</p>
                                    </div>
                                    <div class="update-actions">
                                        <button class="btn btn-primary" id="install-update-btn">
                                            <i data-lucide="power"></i>
                                            Restart and Install
                                        </button>
                                        <button class="btn btn-secondary" id="install-later-btn">
                                            Install Later
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="settings-section">
                                    <h4><i data-lucide="info"></i> Update Settings</h4>
                                    <p class="settings-note">
                                        CodeAgentSwarm automatically checks for updates on startup and every 4 hours.
                                        Updates are downloaded in the background and installed when you restart the app.
                                    </p>
                                </div>
                                
                                <!-- Version History Section -->
                                <div class="settings-section">
                                    <h4><i data-lucide="history"></i> Version History</h4>
                                    <div class="version-history-container">
                                        <div class="version-history-loading" id="version-history-loading" style="display: none;">
                                            <i data-lucide="loader-2" class="spin"></i>
                                            <span>Loading version history...</span>
                                        </div>
                                        <div class="version-history-error" id="version-history-error" style="display: none;">
                                            <i data-lucide="alert-circle"></i>
                                            <span>Failed to load version history</span>
                                        </div>
                                        <div class="version-history-list" id="version-history-list">
                                            <!-- Version history items will be inserted here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- MCP Tips Tab -->
                        <div class="tab-panel" data-panel="mcp-tips">
                            <div class="settings-section">
                                <h3><i data-lucide="alert-circle"></i> MCP Connection Issues</h3>
                                <p>If <code>/mcp</code> command doesn't work in Claude Code:</p>
                                <ul class="settings-list">
                                    <li>Try restarting your terminal - MCP connections can sometimes disconnect</li>
                                    <li>Close and reopen Claude Code to refresh the connection</li>
                                    <li>Make sure CodeAgentSwarm is running</li>
                                </ul>
                            </div>
                            
                            <div class="settings-section">
                                <h3><i data-lucide="terminal"></i> About Claude Code</h3>
                                <p>Claude Code is a terminal application that gets updated regularly. If the functionality changes:</p>
                                <ul class="settings-list">
                                    <li>CodeAgentSwarm may need updates to maintain compatibility</li>
                                    <li>Check for CodeAgentSwarm updates when Claude Code updates</li>
                                    <li>Report issues on our GitHub repository</li>
                                </ul>
                            </div>
                            
                            <div class="settings-section">
                                <h3><i data-lucide="zap"></i> Quick Tips</h3>
                                <ul class="settings-list">
                                    <li>MCP tools are available via <code>/mcp</code> command in Claude Code</li>
                                    <li>Task management is integrated with your terminal workflow</li>
                                    <li>Each terminal can have its own active task</li>
                                    <li>Tasks automatically sync between terminals and the Kanban board</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="close-settings">Close</button>
            </div>
        </div>
    </div>

    <!-- Auth Dropdown Menu -->
    <div class="auth-dropdown" id="auth-dropdown" style="display: none;">
        <div class="auth-dropdown-content">
            <div class="auth-user-info" id="dropdown-auth-user-info" style="display: none;">
                <img id="dropdown-user-avatar-section" class="user-avatar-large" />
                <div class="user-details">
                    <div class="user-name" id="dropdown-user-name"></div>
                    <div class="user-email" id="dropdown-user-email"></div>
                </div>
            </div>
            <div class="auth-dropdown-header" id="dropdown-auth-header-signed-out">
                <p style="margin: 0; padding: 12px 16px 8px; font-size: 11px; color: var(--text-secondary); font-weight: 600; letter-spacing: 0.5px; text-transform: uppercase; opacity: 0.7;">Choose your account</p>
            </div>
            <div class="auth-menu-items" id="dropdown-auth-menu-signed-out">
                <button class="auth-menu-item dropdown-auth-provider" data-provider="github">
                    <i data-lucide="github"></i>
                    <span>Continue with GitHub</span>
                </button>
                <button class="auth-menu-item dropdown-auth-provider" data-provider="google">
                    <svg class="google-icon" viewBox="0 0 24 24" width="20" height="20">
                        <path fill="#4285f4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34a853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#fbbc05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#ea4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Continue with Google</span>
                </button>
                <button class="auth-menu-item dropdown-auth-provider" data-provider="discord">
                    <svg class="discord-icon" viewBox="0 0 24 24" width="20" height="20">
                        <path fill="white" d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                    </svg>
                    <span>Continue with Discord</span>
                </button>
            </div>
            <div class="auth-menu-items" id="dropdown-auth-menu-signed-in" style="display: none;">
                <button class="auth-menu-item" id="dropdown-auth-logout">
                    <i data-lucide="log-out"></i>
                    <span>Sign Out</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Add MCP Server Modal -->
    <div class="modal" id="add-mcp-modal">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2><i data-lucide="server-cog"></i> Add MCP Server</h2>
                <button class="close-button" id="close-add-mcp">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="mcp-add-form">
                    <div class="form-group">
                        <label for="mcp-json-input">Paste MCP Configuration JSON:</label>
                        <textarea 
                            id="mcp-json-input" 
                            class="mcp-json-textarea" 
                            placeholder='{
  "mcpServers": {
    "server-name": {
      "command": "npx",
      "args": ["-y", "@package/name"],
      "env": {
        "API_KEY": "your-key"
      }
    }
  }
}'
                            rows="12"></textarea>
                        <div class="json-validation-message" id="json-validation-message"></div>
                    </div>
                    
                    <div class="mcp-preview" id="mcp-preview" style="display: none;">
                        <h4>Configuration Preview:</h4>
                        <div class="mcp-preview-content" id="mcp-preview-content"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-add-mcp">Cancel</button>
                <button class="btn btn-primary" id="save-mcp-btn" disabled>
                    <i data-lucide="save"></i>
                    Save MCP Server
                </button>
            </div>
        </div>
    </div>

    <!-- Edit MCP Server Modal -->
    <div class="modal" id="edit-mcp-modal">
        <div class="modal-content modal-medium">
            <div class="modal-header">
                <h2><i data-lucide="edit"></i> Edit MCP Server</h2>
                <button class="close-button" id="close-edit-mcp">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="mcp-edit-form">
                    <input type="hidden" id="edit-mcp-name">
                    <div class="form-group">
                        <label for="edit-mcp-json-input">MCP Configuration:</label>
                        <textarea 
                            id="edit-mcp-json-input" 
                            class="mcp-json-textarea" 
                            rows="12"></textarea>
                        <div class="json-validation-message" id="edit-json-validation-message"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancel-edit-mcp">Cancel</button>
                <button class="btn btn-primary" id="update-mcp-btn">
                    <i data-lucide="save"></i>
                    Update MCP Server
                </button>
            </div>
        </div>
    </div>

    <!-- Fullscreen Changelog Modal -->
    <div class="modal" id="fullscreen-changelog-modal">
        <div class="modal-content modal-fullscreen">
            <div class="modal-header">
                <h2><i data-lucide="file-text"></i> Changelog</h2>
                <button class="close-button" id="close-fullscreen-changelog">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="fullscreen-changelog-content" class="changelog-fullscreen-content">
                    <!-- Changelog content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal" style="display: none;">
        <div class="auth-modal-content">
            <div class="auth-modal-header">
                <h2>Login</h2>
                <button class="close-modal" id="close-auth-modal">
                    <i data-lucide="x"></i>
                </button>
            </div>
            <div class="auth-modal-body">
                <!-- Signed Out State -->
                <div id="auth-menu-signed-out" class="auth-menu-items">
                    <p class="auth-subtitle">Sign in to sync your settings and preferences</p>
                    
                    <button class="auth-menu-item" data-provider="github">
                        <i data-lucide="github"></i>
                        <span>Sign in with GitHub</span>
                    </button>
                    
                    <button class="auth-menu-item" data-provider="google">
                        <svg width="20" height="20" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                            <path fill="#4285F4" d="M45.12 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h11.84c-.51 2.75-2.06 5.08-4.39 6.64v5.52h7.11c4.16-3.83 6.56-9.47 6.56-16.17z"/>
                            <path fill="#34A853" d="M24 46c5.94 0 10.92-1.97 14.56-5.33l-7.11-5.52c-1.97 1.32-4.49 2.1-7.45 2.1-5.73 0-10.58-3.87-12.31-9.07H4.34v5.7C7.96 41.07 15.4 46 24 46z"/>
                            <path fill="#FBBC04" d="M11.69 28.18C11.25 26.86 11 25.45 11 24s.25-2.86.69-4.18v-5.7H4.34C2.85 17.09 2 20.45 2 24c0 3.55.85 6.91 2.34 9.88l7.35-5.7z"/>
                            <path fill="#EA4335" d="M24 10.75c3.23 0 6.13 1.11 8.41 3.29l6.31-6.31C34.91 4.18 29.93 2 24 2 15.4 2 7.96 6.93 4.34 14.12l7.35 5.7c1.73-5.2 6.58-9.07 12.31-9.07z"/>
                        </svg>
                        <span>Sign in with Google</span>
                    </button>
                    
                    <button class="auth-menu-item" data-provider="discord">
                        <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path fill="currentColor" d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.956-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419c0-1.333.955-2.419 2.157-2.419c1.21 0 2.176 1.096 2.157 2.42c0 1.333-.946 2.418-2.157 2.418z"/>
                        </svg>
                        <span>Sign in with Discord</span>
                    </button>
                </div>
                
                <!-- Signed In State -->
                <div id="auth-menu-signed-in" class="auth-menu-items" style="display: none;">
                    <div id="auth-user-info" class="auth-user-info">
                        <img id="dropdown-user-avatar" class="user-avatar-large" alt="Avatar" />
                        <div class="user-details">
                            <div id="user-name" class="user-name"></div>
                            <div id="user-email" class="user-email"></div>
                        </div>
                    </div>
                    
                    <button id="auth-logout" class="auth-menu-item">
                        <i data-lucide="log-out"></i>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../../node_modules/xterm/lib/xterm.js"></script>
    <script src="../../../node_modules/xterm-addon-fit/lib/xterm-addon-fit.js"></script>
    <script src="../../../node_modules/xterm-addon-web-links/lib/xterm-addon-web-links.js"></script>
    <script>
        // Handle external links with debouncing to prevent double-click crashes
        document.addEventListener('DOMContentLoaded', () => {
            const { shell } = require('electron');
            let linkClickTimeouts = new Map();
            let lastClickTimes = new Map();
            const DOUBLE_CLICK_DELAY = 300; // milliseconds
            
            // Intercept all link clicks
            document.addEventListener('click', (event) => {
                const link = event.target.closest('a[target="_blank"]');
                if (!link) return;
                
                event.preventDefault();
                const href = link.href;
                const currentTime = Date.now();
                const lastClickTime = lastClickTimes.get(href) || 0;
                
                // Ignore rapid clicks
                if (currentTime - lastClickTime < DOUBLE_CLICK_DELAY) {
                    console.log('Ignoring rapid link click:', href);
                    return;
                }
                
                // Clear any pending timeout for this link
                const existingTimeout = linkClickTimeouts.get(href);
                if (existingTimeout) {
                    clearTimeout(existingTimeout);
                }
                
                // Set timeout to handle the click
                const timeout = setTimeout(() => {
                    console.log('Opening external link:', href);
                    shell.openExternal(href).catch(err => {
                        console.error('Failed to open link:', err);
                    });
                    linkClickTimeouts.delete(href);
                }, 50);
                
                linkClickTimeouts.set(href, timeout);
                lastClickTimes.set(href, currentTime);
            }, true);
        });
    </script>
    <script src="../../infrastructure/mcp/mcp-permissions-modal.js"></script>
    <script src="../components/global-permissions-client-simple.js"></script>
    <script src="../renderer/renderer.js"></script>
    <script src="../renderer/auth-manager.js"></script>
    
    <!-- MCP Marketplace Modal (separate from settings) -->
    <div id="marketplace-modal" class="modal" style="display: none;">
        <div class="modal-content marketplace-modal-content">
            <div class="modal-header">
                <h2><i data-lucide="shopping-bag"></i> MCP Marketplace</h2>
                <button class="close-modal" id="close-marketplace">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body marketplace-modal-body">
                <div id="mcp-marketplace-container">
                    <!-- Marketplace will be rendered here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- MCP Permissions Modal -->
    <div id="permissions-modal" class="modal" style="display: none;">
        <div class="modal-content permissions-modal-content">
            <div class="modal-header">
                <h2><i data-lucide="shield"></i> MCP Permissions</h2>
                <button class="close-modal" id="close-permissions">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 5L5 15M5 5L15 15" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body permissions-modal-body">
                <div class="permissions-info">
                    <p>Configure permissions for MCP tools. Choose how Claude should handle each tool:</p>
                    <div class="permission-legend">
                        <span class="legend-item"><span class="legend-dot deny"></span> Deny - Block this tool</span>
                        <span class="legend-item"><span class="legend-dot ask"></span> Ask - Request confirmation</span>
                        <span class="legend-item"><span class="legend-dot allow"></span> Allow - Auto-approve</span>
                    </div>
                </div>
                <div class="permissions-search">
                    <input type="text" id="permissions-search" placeholder="Search MCP tools...">
                </div>
                <div id="mcp-permissions-list" class="mcp-permissions-list">
                    <!-- MCP permissions will be loaded here -->
                </div>
                <div class="permissions-footer">
                    <button class="btn btn-secondary" id="reset-permissions">Reset to Defaults</button>
                    <button class="btn btn-primary" id="save-permissions">Save Changes</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>